name: Notebook Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  notebook-validation:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install nbformat nbconvert jupyter
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Check notebook format
      run: |
        for notebook in $(find . -name "*.ipynb" -not -path "*/.*"); do
          echo "Validating $notebook"
          jupyter nbconvert --to notebook --execute --inplace "$notebook" --ExecutePreprocessor.timeout=600 || true
        done
      continue-on-error: true
    
    - name: Check for notebook outputs
      run: |
        echo "Checking if notebooks have cleared outputs (best practice for version control)"
        for notebook in $(find . -name "*.ipynb" -not -path "*/.*"); do
          echo "Checking $notebook"
          python -c 'import json; f = open("'"$notebook"'", "r"); nb = json.load(f); f.close(); has_outputs = any(cell.get("outputs", []) for cell in nb.get("cells", []) if cell.get("cell_type") == "code"); print("⚠️  Warning: '"$notebook"' contains cell outputs. Consider clearing outputs before committing." if has_outputs else "✓ '"$notebook"' has cleared outputs.")' || true
        done
      continue-on-error: true
